name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Find project root
        id: find-project
        run: |
          if [ -f "settings.gradle" ]; then
            echo "project_dir=." >> $GITHUB_OUTPUT
          elif [ -f "MKNotes/settings.gradle" ]; then
            echo "project_dir=MKNotes" >> $GITHUB_OUTPUT
          else
            FOUND=$(find . -maxdepth 3 -name "settings.gradle" -type f | head -1)
            if [ -n "$FOUND" ]; then
              echo "project_dir=$(dirname $FOUND)" >> $GITHUB_OUTPUT
            else
              echo "ERROR: No settings.gradle found anywhere!"
              exit 1
            fi
          fi
          echo "Using project directory: $(cat $GITHUB_OUTPUT)"

      - name: Download and install Gradle 7.5.1
        run: |
          curl -sL https://services.gradle.org/distributions/gradle-7.5.1-bin.zip -o /tmp/gradle.zip
          unzip -q /tmp/gradle.zip -d /opt/gradle
          echo "/opt/gradle/gradle-7.5.1/bin" >> $GITHUB_PATH

      - name: Build Release APK
        working-directory: ${{ steps.find-project.outputs.project_dir }}
        run: gradle assembleRelease --no-daemon --stacktrace

      - name: Find and upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MKNotes-release-apk
          path: "**/app/build/outputs/apk/**/*.apk"
          if-no-files-found: warn
